@startuml
!theme plain
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2
skinparam roundcorner 10

actor User as user
participant "Reminder Scheduler" as remsched
participant "Settings" as settings
database "SQLite Database" as db
participant "Event Manager" as eventmgr
participant "Message Formatter" as msgfmt
participant "Telegram Bot API" as tgapi

note over remsched: Quality Requirement:\nReminders must be delivered\nwith delay < 1 minute\n(Check interval: 60 seconds)

== Scheduled Reminder Check (Every 60 seconds) ==

remsched -> remsched: Timer trigger at T0
activate remsched
note right of remsched: T0: Check starts\n(Every 60 seconds)

remsched -> db: SELECT events WHERE reminder_time <= NOW()\nAND reminder_sent = false
activate db
note right of db: Query must complete < 100ms
db --> remsched: Events list (T0 + 50ms)
deactivate db

alt Events found
    loop For each event needing reminder
        remsched -> settings: Get user settings(user_id)
        activate settings
        note right of settings: Settings retrieval < 50ms
        
        settings -> db: SELECT settings WHERE user_id = ?
        activate db
        db --> settings: User settings (T0 + 100ms)
        deactivate db
        
        settings --> remsched: User settings (T0 + 100ms)
        deactivate settings
        
        remsched -> remsched: Check quiet hours
        note right of remsched: Quiet hours check < 10ms
        
        alt Current time in quiet hours
            remsched -> db: UPDATE events SET reminder_time = reminder_time + 1 hour
            activate db
            db --> remsched: Updated (T0 + 150ms)
            deactivate db
            note over remsched: Reminder deferred\n(quiet hours)
        else Not in quiet hours
            remsched -> eventmgr: Get event details(event_id)
            activate eventmgr
            note right of eventmgr: Event retrieval < 50ms
            
            eventmgr -> db: SELECT * FROM events WHERE id = ?
            activate db
            db --> eventmgr: Event details (T0 + 200ms)
            deactivate db
            
            eventmgr --> remsched: Event details (T0 + 200ms)
            deactivate eventmgr
            
            remsched -> msgfmt: Format reminder message(event)
            activate msgfmt
            note right of msgfmt: Formatting < 50ms
            msgfmt --> remsched: Formatted message (T0 + 250ms)
            deactivate msgfmt
            
            remsched -> tgapi: Send reminder message(user_id, message)
            activate tgapi
            note right of tgapi: Telegram API call\nmust complete < 800ms
            tgapi -> user: Reminder delivered (T0 + 1050ms)
            deactivate tgapi
            
            remsched -> db: UPDATE events SET reminder_sent = true
            activate db
            db --> remsched: Updated (T0 + 1100ms)
            deactivate db
            
            note over remsched, user: Total time: < 1.1 seconds\nRequirement: < 60 seconds ✓
        end
    end
end

remsched -> remsched: Next check scheduled (T0 + 60s)
deactivate remsched

note over remsched: Performance Constraints:\n- Database query: < 100ms\n- Settings retrieval: < 50ms\n- Event retrieval: < 50ms\n- Message formatting: < 50ms\n- Telegram API: < 800ms\n- Total per reminder: < 1.1s\n- System check interval: 60s\n- Maximum delay: < 60s ✓

@enduml

