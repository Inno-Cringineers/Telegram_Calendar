@startuml
!theme plain
skinparam sequenceMessageAlign center
skinparam sequenceArrowThickness 2
skinparam roundcorner 10

actor User as user
participant "Reminder Scheduler" as remsched
participant "Settings" as settings
database "SQLite Database" as db
participant "Event Manager" as eventmgr
participant "Message Formatter" as msgfmt
participant "Telegram Bot API" as tgapi

== Scheduled Reminder Check ==

remsched -> remsched: Timer trigger (every minute)
activate remsched

remsched -> db: select query
activate db
db --> remsched: List of events needing reminders
deactivate db

loop For each event needing reminder
    remsched -> settings: Get user settings(user_id)
    activate settings
    
    settings -> db: SELECT settings WHERE user_id = ?
    activate db
    db --> settings: User settings (quiet_hours, timezone)
    deactivate db
    
    settings --> remsched: User settings
    deactivate settings
    
    remsched -> remsched: Check quiet hours
    activate remsched
    
    alt Current time in quiet hours
        remsched -> remsched: Skip reminder (quiet hours)
        remsched -> db: UPDATE events SET reminder_time = reminder_time + 1 hour
        activate db
        db --> remsched: Updated
        deactivate db
        deactivate remsched
    else Not in quiet hours
        remsched -> eventmgr: Get event details(event_id)
        activate eventmgr
        
        eventmgr -> db: SELECT * FROM events WHERE id = ?
        activate db
        db --> eventmgr: Event details
        deactivate db
        
        eventmgr --> remsched: Event details
        deactivate eventmgr
        
        remsched -> msgfmt: Format reminder message(event)
        activate msgfmt
        msgfmt --> remsched: Formatted reminder message
        deactivate msgfmt
        
        remsched -> tgapi: Send reminder message(user_id, message)
        activate tgapi
        tgapi -> user: "Reminder: Event Title\nTime: 15:00\nLocation: ..."
        deactivate tgapi
        
        remsched -> db: UPDATE events SET reminder_sent = true
        activate db
        db --> remsched: Updated
        deactivate db
        deactivate remsched
    end
end

remsched -> remsched: Wait for next check
deactivate remsched

alt No events need reminders
    remsched -> remsched: Wait for next check
    deactivate remsched
end

@enduml

