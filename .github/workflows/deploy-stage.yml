name: Deploy Stage

on:
  push:
    branches: ["main"]
    paths: ["app/**", ".github/workflows/**"]

jobs:
  deploy:
    environment:
      name: staging
    runs-on: ubuntu-latest
    steps:
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        run: |
          sshpass -p "$DEPLOY_PASSWORD" ssh "$DEPLOY_USER@$DEPLOY_HOST" << 'EOF'
            cd stage
            git pull
            cd app
            docker compose -f docker-compose.stage.yml down
            docker compose -f docker-compose.stage.yml up -d --build
          EOF
